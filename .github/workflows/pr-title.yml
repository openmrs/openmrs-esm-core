name: PR Title Cop

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  title-patrol:
    runs-on: ubuntu-latest
    steps:
      - name: Lint PR Title
        uses: actions/github-script@v6
        with:
          script: |
            const title = context.payload.pull_request.title.trim();
            const PREFIX_REGEX = /^(?:\((feat|fix|docs|chore|test)\)|BREAKING:)\s/;
            const TICKET_PRESENT_REGEX = /^(?:\((feat|fix|docs|chore|test)\)|BREAKING:)\s+(\w+\s?-\s?\w+)/;
            const TICKET_FORMAT_REGEX = /^(?:\((feat|fix|docs|chore|test)\)|BREAKING:)\s+[A-Z][a-zA-Z0-9]*-\d{1,8}:/;
            const DESC_AFTER_PREFIX_REGEX = /^(?:\((feat|fix|docs|chore|test)\)|BREAKING:)\s+\w(?:.+)?/;
            const DESC_AFTER_TICKET_REGEX = /^(?:\((feat|fix|docs|chore|test)\)|BREAKING:)\s+(\w+\s?-\s?\w+):\s+?\w(.+)?/;
            
            if (!PREFIX_REGEX.test(title)) {
              core.setFailed(`
                âŒ Invalid PR title prefix format. Please follow these requirements:

                REQUIRED FORMAT:
                â€¢ Start with one of these prefixes:
                  - "(feat) "     (note the space after)
                  - "(fix) "      (note the space after)
                  - "(docs) "     (note the space after)
                  - "(chore) "    (note the space after)
                  - "(test) "     (note the space after)
                  - "BREAKING: "  (note the space after)

                â€¢ Optionally include a ticket number (e.g., "O3-1234:")
                â€¢ Follow with a descriptive title

                COMMON MISTAKES TO AVOID:
                âœ– "(feat)TRUNK-48456" â†’ Missing space after "(feat)"
                âœ– "BREAKING:for breaking changes" â†’ Missing space after "BREAKING:"
                âœ– "(feat TRUNK-48456" â†’ Missing closing parenthesis
                âœ– "feat: O3-486" â†’ Wrong format (should use parentheses)
                âœ– "(BREAKING): O3-345" â†’ Wrong format (DON'T use parentheses for BREAKING)

                VALID EXAMPLES:
                âœ“ "(chore) Remove orders widget feature flag"
                âœ“ "(fix) O3-2657: Show inline errors"
                âœ“ "(feat) O3-2724: Move overlays into the framework"
                âœ“ "BREAKING: Upgrade to Carbon v11"
                âœ“ "BREAKING: TRUNK-874: Upgrade to React v18"
                âœ“ "(docs) Add steps for running E2E tests"

                YOUR TITLE: "${title}"
                PROBLEM: ${title.match(/^(?:\((feat|fix|docs|chore|test)\)|BREAKING:)/) ? 
                          'Missing required space after the prefix' : 
                          'Missing or invalid prefix'}

                WHY THIS MATTERS:
                These labels determine version bumps when releasing modules and generate our changelogs.

                Need help? Ask your reviewer about which label to use!
              `);
              return;
            }
            
            if (TICKET_PRESENT_REGEX.test(title)) {
              if (!TICKET_FORMAT_REGEX.test(title)) {
                core.setFailed(`
                  âŒ Invalid ticket number format in your PR title. Please follow these rules:

                  TICKET NUMBER REQUIREMENTS:
                  â€¢ Must start with uppercase letters (e.g., O3, TRUNK, ITSMOLD)
                  â€¢ Followed by a hyphen (-)
                  â€¢ Followed by 1-8 digits
                  â€¢ Must end with ": " (colon and space)
                  
                  VALID FORMATS:
                  âœ“ "(feat) O3-1234: Add new feature"
                  âœ“ "(fix) TRUNK-453: Fix alignment issue"
                  âœ“ "BREAKING: ITSMOLD-2932: Migrate database"

                  COMMON MISTAKES:
                  âœ– "O3-123" â†’ Missing colon and space
                  âœ– "o3-123: " â†’ Lowercase prefix (should be O3)
                  âœ– "03-123: " â†’ Starts with number (should be O3)
                  âœ– "TRUNK-123456789: " â†’ Too many digits (max 8)
                  âœ– "TRUNK-: " â†’ Missing ticket number

                  YOUR TITLE: "${title}"

                  EXAMPLES OF VALID TICKETS:
                  â€¢ O3-123
                  â€¢ TRUNK-453
                  â€¢ ITSMOLD-2932
                  â€¢ IFRA-44
                  â€¢ BIR-24

                  Remember: The ticket number must be followed by ": " before your description.
                `);
                return;
              }
            } else {
              const DESC_AFTER_PREFIX_REGEX = /^(?:\((feat|fix|docs)\)|BREAKING:)\s+\w(?:.+)?/;
              if (!DESC_AFTER_PREFIX_REGEX.test(title)) {
                core.setFailed(`
                  âŒ PR title is missing a description.

                  Please add a description after the prefix. Examples:
                  â€¢ "(feat) Add new login button"
                  â€¢ "(fix) Resolve header alignment issue"
                  â€¢ "(docs) Update API documentation"
                  â€¢ "BREAKING: Remove deprecated endpoints"

                  Your title: "${title}"
                `);
                return;
              } else {
                core.info(`
                  âœ… PR title looks great! Here's what we found:
                  
                  â€¢ Valid prefix
                  â€¢ Has a description
                  
                  Good to go! ğŸš€
                `);
                return;
              }
            }
            
            if (!DESC_AFTER_TICKET_REGEX.test(title)) {
              core.setFailed(`
                âŒ PR Title Missing a Description

                Validation Requirements:
                - Title must include a descriptive text after the ticket reference
                - Format: "(type) TICKET-123: Description text" 
                - The colon (:) after ticket number must be followed by a space and description

                Current Title: "${title}"
                
                Correct Examples:
                â€¢ "(feat) O3-1234: Implement dark mode toggle"
                â€¢ "(fix) TRUNK-453: Resolve header alignment issue"
                â€¢ "BREAKING: ITSMOLD-2932: Remove deprecated API endpoints"

                Please add a clear description after the ticket reference.
              `);
              return;
            }

            core.info(`
              âœ… PR Title Validation Passed - All Requirements Met

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  PR TITLE VALIDATION SUMMARY                         â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚  âœ“ Valid Prefix:                                     |
              â”‚  âœ“ Ticket Format:                                    |
              â”‚  âœ“ Description:                                      |
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚  Full Title: "${title}"                              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

              All checks passed:
              â€¢ Conventional commit prefix validated
              â€¢ Ticket number format correct (UPPERCASE-123:)
              â€¢ Description present and properly formatted

              Ready for review! ğŸš€
            `);
